# Section6-分支管理(Part2)

## 1. 解决冲突

人生不如意之事十之八九，合并分支往往也不是一帆风顺的。

如果两个分支存在冲突，Git 无法执行“快速合并”，只能试图把各自的修改合并起来

Git 告诉我们，存在冲突，必须手动解决冲突后再提交。`git status` 也可以告诉我们冲突的文件：

Git 用`<<<<<<<`，`=======`，`>>>>>>>`标记出不同分支的内容，我们修改后保存

再提交后，如果没有问题，会直接自动合并

用带参数的 `git log` 也可以看到分支的合并情况，用 `git log --graph` 命令可以看到分支合并图。

## 2. 分支管理策略

通常，合并分支时，如果可能，Git 会用 `Fast forward` 模式，但这种模式下，删除分支后，会丢掉分支信息。

如果要强制禁用 `Fast forward` 模式，Git 就会在 merge 时生成一个新的 commit，这样，从分支历史上就可以看出分支信息。

下面我们实战一下`--no-ff` 方式的 `git merge`：

```
$ git merge --no-ff -m "merge with no-ff" dev
```

不使用 Fast forward 模式，merge 后就像这样：

![](../../img/gitNotes/merge1.png ":size=40%")

## 3. 分支策略

在实际开发中，我们应该按照几个基本原则进行分支管理：

首先，`master` 分支应该是非常稳定的，也就是仅用来发布新版本，平时不能在上面干活；

那在哪干活呢？干活都在 `dev` 分支上，也就是说，`dev` 分支是不稳定的，到某个时候，比如 1.0 版本发布时，再把 `dev` 分支合并到 master 上，在 master 分支发布 1.0 版本；

你和你的小伙伴们每个人都在 `dev` 分支上干活，每个人都有自己的分支，时不时地往 `dev` 分支上合并就可以了。

所以，团队合作的分支看起来就像这样：

![](../../img/gitNotes/merge2.png ":size=50%")

## 4. Bug 分支

在 Git 中，由于分支是如此的强大，所以，每个 bug 都可以通过一个新的临时分支来修复，修复后，合并分支，然后将临时分支删除。

在切换分支的时候，要注意，如果你在当前分支上有未提交的更改，Git 会阻止你切换到另一个分支，所以我们要先临时保存当然的人物

Git 还提供了一个 `stash` 功能，可以把当前工作现场“储藏”起来，等以后恢复现场后继续工作

如果要修复 master 分支的 bug，就从 master 建一个临时分支，然后合并就好

修完后切换到原分支，可以用 `git stash list` 命令看看

工作现场还在，Git 把 stash 内容存在某个地方了，但是需要恢复一下，有两个办法：

一是用 `git stash apply`恢复，但是恢复后，stash 内容并不删除，你需要用`git stash drop` 来删除；

另一种方式是用 `git stash pop`，恢复的同时把 stash 内容也删了：

现在的分支其实也有 bug，为了减少重复工作，我们可以直接把在 master 的修改直接复制到现在的分支

为了方便操作，Git 专门提供了一个 · 命令，让我们能复制一个特定的提交到当前分支

## 5. Feature 分支

现在我们要加入新的功能，正常来说和处理 bug 的步骤是差不多的。

开发完之后，一切顺利的话，feature 分支和 bug 分支是类似的，合并，然后删除。

但是突然，新功能必须取消，所以我们要销毁新功能，所以执行

```
$ git branch -d feature-vulcan
```

销毁失败。Git 友情提醒，feature-vulcan 分支还没有被合并，如果删除，将丢失掉修改，如果要强行删除，需要使用大写的-D 参数。

现在我们强行删除：

```
$ git branch -D feature-vulcan
```

删除成功！

## 6. 多人协作

当你从远程仓库克隆时，实际上 Git 自动把本地的 `master` 分支和远程的 `master` 分支对应起来了，并且，远程仓库的默认名称是 `origin`。

要查看远程库的信息，用 `git remote`, 用 `git remote -v` 显示更详细的信息

### 推送分支

推送分支，就是把该分支上的所有本地提交推送到远程库。推送时，要指定本地分支，这样，Git 就会把该分支推送到远程库对应的远程分支上：

```
$ git push origin master
```

如果要推送其他分支，比如 `dev`，就改成：

```
$ git push origin dev 1
```

但是，并不是一定要把本地分支往远程推送，那么，哪些分支需要推送，哪些不需要呢？

- `master` 分支是主分支，因此要时刻与远程同步；

- `dev` 分支是开发分支，团队所有成员都需要在上面工作，所以也需要与远程同步；

- bug 分支只用于在本地修复 bug，就没必要推到远程了，除非老板要看看你每周到底修复了几个 bug；

- feature 分支是否推到远程，取决于你是否和你的小伙伴合作在上面开发。

总之，就是在 Git 中，分支完全可以在本地自己藏着玩，是否推送，视你的心情而定！

### 抓取分支

多人协作时，大家都会往 `master` 和 `dev` 分支上推送各自的修改

但是从远程库抓取，只会得到 `master` 分支，如过想要 `dev` 分支，就必须创建远程 `origin` 的 `dev` 分支到本地，于是他用这个命令创建本地 dev 分支

```
$ git checkout -b dev origin/dev
```

这样就有了 `dev` 分支，可以 push 到远程仓库了

### 多人协作的工作模式

首先，可以试图用 `git push origin <branch-name>`推送自己的修改；

如果推送失败，则因为远程分支比你的本地更新，需要先用 `git pull` 试图合并；

如果合并有冲突，则解决冲突，并在本地提交；

没有冲突或者解决掉冲突后，再用 `git push origin <branch-name>`推送就能成功！

如果 `git pull` 提示 no tracking information，则说明本地分支和远程分支的链接关系没有创建，用命令 `git branch --set-upstream-to <branch-name> origin/<branch-name>`。

这就是多人协作的工作模式，一旦熟悉了，就非常简单。

## 7. Rebase

- rebase 操作可以把本地未 push 的分叉提交历史整理成直线；

- rebase 的目的是使得我们在查看历史提交的变化时更容易，因为分叉的提交需要三方对比。

[相关视频](https://www.bilibili.com/video/BV1Xb4y1773F/?spm_id_from=333.1007.top_right_bar_window_history.content.click)
